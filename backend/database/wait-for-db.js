const { Pool } = require('pg');
require('dotenv').config();

async function waitForDatabase() {
    console.log('‚è≥ Waiting for PostgreSQL database to be ready...');
    
    const pool = new Pool({
        connectionString: process.env.DATABASE_URL,
        ssl: process.env.NODE_ENV === 'production' ? { rejectUnauthorized: false } : false,
        // Kratki timeout za br≈æe failanje
        connectionTimeoutMillis: 5000,
        query_timeout: 5000
    });

    let attempts = 0;
    const maxAttempts = 30; // 30 poku≈°aja = 2.5 minuta
    
    while (attempts < maxAttempts) {
        try {
            attempts++;
            console.log('üîå Attempting database connection...', 'Attempt', attempts, 'of', maxAttempts);
            
            // Poku≈°aj spojiti se na bazu
            const client = await pool.connect();
            console.log('‚úÖ Database connection successful!');
            
            // Testiraj connection
            await client.query('SELECT NOW()');
            console.log('‚úÖ Database is responding to queries');
            
            client.release();
            await pool.end();
            
            console.log('üéâ Database is ready for initialization!');
            return true;
            
        } catch (error) {
            console.log('‚ùå Database not ready yet:', error.message);
            
            if (attempts >= maxAttempts) {
                console.log('üí• Max connection attempts reached. Database might not be available.');
                await pool.end();
                return false;
            }
            
            // ƒåekaj 5 sekundi prije sljedeƒáeg poku≈°aja
            console.log('‚è∞ Waiting 5 seconds before retry...');
            await new Promise(resolve => setTimeout(resolve, 5000));
        }
    }
    
    await pool.end();
    return false;
}

// Pokreni ƒçekanje ako je skripta pozvana direktno
if (require.main === module) {
    waitForDatabase()
        .then(success => {
            if (success) {
                console.log('üöÄ Proceeding with database initialization...');
                process.exit(0);
            } else {
                console.log('üí• Cannot connect to database. Exiting.');
                process.exit(1);
            }
        })
        .catch(error => {
            console.error('üí• Error waiting for database:', error);
            process.exit(1);
        });
}

module.exports = { waitForDatabase };
