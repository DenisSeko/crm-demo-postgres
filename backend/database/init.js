// database/init.js
import { pool } from './config.js';
import fs from 'fs';
import path from 'path';
import { fileURLToPath } from 'url';

const __filename = fileURLToPath(import.meta.url);
const __dirname = path.dirname(__filename);

export async function initializeDatabase() {
    console.log('üöÄ Starting database initialization...');
    
    let client;
    try {
        console.log('üîó Testing database connection...');
        client = await pool.connect();
        
        // Test connection
        const result = await client.query('SELECT version()');
        console.log('‚úÖ Database connected:', result.rows[0].version);
        
        // Pronaƒëi schema.sql
        const schemaPath = findSchemaFile();
        
        if (schemaPath) {
            console.log(`üìÑ Found schema file: ${schemaPath}`);
            await importSchema(client, schemaPath);
        } else {
            console.log('‚ö†Ô∏è No schema file found, checking existing tables...');
            await checkExistingTables(client);
        }

        console.log('üéâ Database initialization completed!');
        return true;
        
    } catch (error) {
        console.error('‚ùå Database initialization failed:', error.message);
        return false;
    } finally {
        if (client) {
            client.release();
        }
    }
}

function findSchemaFile() {
    const possiblePaths = [
        path.join(process.cwd(), 'database', 'schema.sql'),
        path.join(process.cwd(), 'schema.sql'),
        path.join(__dirname, 'schema.sql'),
        'schema.sql'
    ];
    
    for (const schemaPath of possiblePaths) {
        if (fs.existsSync(schemaPath)) {
            return schemaPath;
        }
    }
    
    console.log('üìÅ Searched in:', possiblePaths);
    return null;
}

async function importSchema(client, schemaPath) {
    try {
        const schemaSQL = fs.readFileSync(schemaPath, 'utf8');
        console.log(`üìä Importing schema (${schemaSQL.length} chars)...`);
        
        await client.query(schemaSQL);
        console.log('‚úÖ Schema imported successfully');
        
    } catch (error) {
        console.error('‚ùå Schema import failed:', error.message);
        // Mo≈æda tabele veƒá postoje, to je OK
    }
}

async function checkExistingTables(client) {
    try {
        const result = await client.query(`
            SELECT table_name 
            FROM information_schema.tables 
            WHERE table_schema = 'public'
        `);
        
        console.log(`üìä Found ${result.rows.length} existing tables:`);
        result.rows.forEach(row => console.log(`   - ${row.table_name}`));
        
    } catch (error) {
        console.error('‚ùå Error checking tables:', error.message);
    }
}

// Samo pokreni ako je direktno pozvan
if (import.meta.url === `file://${process.argv[1]}`) {
    initializeDatabase();
}