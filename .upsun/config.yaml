applications:
  app:
    type: 'nodejs:20'
    relationships:
      database:
        service: postgresql
        endpoint: postgresql
    
    web:
      commands:
        start: "node backend/server.js"
      locations:
        '/':
          root: 'frontend/dist'
          index: ['index.html']
          passthru: true
          expires: -1
          allow: true
          scripts: true
        '/assets':
          root: 'frontend/dist/assets'
          expires: 1y
          allow: true
        '/api':
          passthru: true
    
    hooks:
      build: |
        set -e
        
        echo "ğŸ“¦ Installing frontend dependencies..."
        cd frontend
        
        # EKSPLICITNO instaliraj sve dependencies (ukljuÄujuÄ‡i devDependencies)
        npm install
        
        echo "ğŸ” Verifying Vite installation..."
        ./node_modules/.bin/vite --version || (echo "âŒ Vite not found" && exit 1)
        
        echo "ğŸ—ï¸ Building frontend..."
        npm run build
        
        # Detaljna provjera builda
        if [ ! -d "dist" ]; then
          echo "âŒ Frontend build failed - no dist directory"
          echo "ğŸ“ Current contents:"
          ls -la
          exit 1
        fi
        
        if [ ! -f "dist/index.html" ]; then
          echo "âŒ Frontend build failed - no index.html"
          echo "ğŸ“ dist contents:"
          ls -la dist/
          exit 1
        fi
        
        echo "âœ… Frontend build successful"
        echo "ğŸ“ Built files:"
        ls -la dist/
        
        echo "ğŸ“¦ Installing backend dependencies..."
        cd ../backend
        npm install
        
        echo "ğŸ—„ï¸ Initializing database with demo data..."
        npm run init-db
        
        echo "ğŸ‰ Build completed successfully!"
    
    mounts:
      'backend/node_modules':
        source: local
        source_path: 'backend/node_modules'
      'frontend/node_modules':
        source: local
        source_path: 'frontend/node_modules'
    
    variables:
      env:
        NODE_ENV: 'production'
        PORT: 8888
        JWT_SECRET: 'your-very-secure-jwt-secret-key-change-this-in-production'

services:
  postgresql:
    type: postgresql:15