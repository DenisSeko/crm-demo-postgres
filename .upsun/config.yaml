applications:
  # Frontend aplikacija (Vue.js)
  frontend:
    source:
      root: frontend
    
    type: 'nodejs:20'
    
    hooks:
      build: |
        npm ci
        npm run build
    
    web:
      locations:
        '/':
          root: 'dist'
          index: ['index.html']
          expires: 1h
          allow: true
          passthru: '/index.html'
          rules:
            \.(css|js|gif|jpe?g|png|svg|ico|woff2?)$:
              allow: true
              expires: 1M
    
    mounts:
      '/.npm':
        source: local
        source_path: npm_cache
    
    relationships:
      backend: 'backend:http'
  
  # Backend aplikacija (Express.js)
  backend:
    source:
      root: backend
    
    type: 'nodejs:20'
    
    hooks:
      build: |
        npm ci --omit=dev
      deploy: |
        node init-db.js
    
    web:
      commands:
        start: 'node server.js'
      locations:
        '/':
          passthru: true
          allow: false
    
    mounts:
      '/.npm':
        source: local
        source_path: npm_cache
    
    relationships:
      database:
        service: postgresql
        endpoint: postgresql
    
    variables:
      env:
        NODE_ENV: 'production'
        PORT: '8080'

services:
  postgresql:
    type: postgresql:15
    configuration:
      extensions:
        - pg_trgm
        - uuid-ossp

routes:
  "https://{default}/":
    type: upstream
    upstream: "frontend:http"
    cache:
      enabled: true
      default_ttl: 3600
  
  "https://{default}/api/":
    type: upstream
    upstream: "backend:http"
    cache:
      enabled: false