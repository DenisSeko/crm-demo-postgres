applications:
  app:
    type: 'nodejs:20'
    relationships:
      database:
        service: postgresql
        endpoint: postgresql
    
    web:
      commands:
        start: "node backend/server.js"
      locations:
        '/':
          root: 'frontend/dist'
          index: ['index.html']
          passthru: true
          expires: -1
          allow: true
          scripts: true
        '/assets':
          root: 'frontend/dist/assets'
          expires: 1y
          allow: true
        '/api':
          passthru: true
    
  hooks:
    build: |
      set -e
          
      echo "ğŸš€ Starting build..."
      
      # Backend
      cd backend
      npm install
      cd ..
      
      # Frontend - samo instaliraj dependencies, npx Ä‡e handle-ati build
      cd frontend
      npm install
      
      # npx Ä‡e automatski pronaÄ‡i i koristiti Vite
      echo "ğŸ—ï¸ Building with npx vite..."
      npx vite build
      
      if [ ! -d "dist" ]; then
        echo "âŒ Build failed"
        exit 1
      fi
      
      echo "âœ… Frontend built"
      
      cd ../backend
      npm run init-db
      
      echo "ğŸ‰ Success!"
    
    mounts:
      'backend/node_modules':
        source: local
        source_path: 'backend/node_modules'
      'frontend/node_modules':
        source: local
        source_path: 'frontend/node_modules'
    
    variables:
      env:
        NODE_ENV: 'production'
        PORT: 8888
        JWT_SECRET: 'your-very-secure-jwt-secret-key-change-this-in-production'

services:
  postgresql:
    type: postgresql:15