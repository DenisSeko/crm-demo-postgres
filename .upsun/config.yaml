applications:
  app:
    type: "nodejs:20"
    relationships:
      database:
        service: postgresql
        endpoint: postgresql

    web:
      commands:
        start: "node backend/server.js"
      locations:
        "/":
          root: "frontend/dist"
          index: ["index.html"]
          passthru: true
          expires: -1
          allow: true
          scripts: true
        "/assets":
          root: "frontend/dist/assets"
          expires: 1y
          allow: true
        "/api":
          passthru: true

    hooks:
      build: |
        set -e
        
        echo "ğŸš€ Starting build process..."
        
        # FRONTEND BUILD
        echo "ğŸ“¦ Building frontend..."
        cd frontend
        
        # Clean install bez production flag
        echo "ğŸ“¥ Installing dependencies..."
        npm install
        
        # Detaljna verifikacija
        echo "ğŸ” Detailed package verification:"
        ls -la node_modules/ | head -20
        npm list vite || echo "Vite not listed but continuing..."
        npm list @vitejs/plugin-vue || echo "Plugin not listed but continuing..."
        
        # Provjeri da li Vite binary postoji
        echo "ğŸ” Checking for Vite binary..."
        if [ -f "node_modules/.bin/vite" ]; then
          echo "âœ… Vite binary found"
          ./node_modules/.bin/vite --version || echo "Vite version check failed but continuing..."
        else
          echo "âŒ Vite binary not found, listing .bin:"
          ls -la node_modules/.bin/ | head -10
        fi
        
        # Build
        echo "ğŸ—ï¸ Running build..."
        npm run build
        
        if [ ! -f "dist/index.html" ]; then
          echo "âŒ Build failed, checking structure..."
          ls -la
          if [ -d "node_modules/vite" ]; then
            echo "ğŸ“ Vite directory exists, trying direct build..."
            node node_modules/vite/bin/vite.js build
          else
            echo "âŒ Vite not installed at all"
            exit 1
          fi
        fi
        
        echo "âœ… Frontend build successful"
        
        # BACKEND
        echo "ğŸ“¦ Backend setup..."
        cd ../backend
        npm install
        
        echo "ğŸ‰ Build completed!"

    variables:
      env:
        NODE_ENV: "production"
        PORT: 8888
        JWT_SECRET: "your-very-secure-jwt-secret-key-change-this-in-production"

services:
  postgresql:
    type: postgresql:15