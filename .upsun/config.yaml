# .upsun/config.yaml
applications:
  app:
    type: "nodejs:20"
    relationships:
      database:
        service: postgresql
        endpoint: postgresql

    web:
      commands:
        start: "node backend/server.js"
      locations:
        "/":
          root: "frontend/dist"
          index: ["index.html"]
          passthru: true
        "/assets":
          root: "frontend/dist/assets"
          expires: 1y
        "/api":
          passthru: true

    hooks:
      build: |
        cd frontend && npm install && npx vite build
        cd ../backend && npm install && npm run init-db

    variables:
      env:
        NODE_ENV: "production"
        PORT: 8888

services:
  postgresql:
    type: postgresql:15