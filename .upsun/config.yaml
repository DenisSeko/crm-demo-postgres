# .upsun/config.yaml

applications:
  app:
    type: "nodejs:20"
    
    relationships:
      database:
        service: postgresql
        endpoint: postgresql

    web:
      commands:
        start: "node backend/server.js"
      locations:
        "/":
          root: "frontend/dist"
          index: ["index.html"]
          passthru: true
          expires: -1
          allow: true
          scripts: true
        "/assets":
          root: "frontend/dist/assets"
          expires: 1y
          allow: true
        "/api":
          passthru: true

    hooks:
      build: |
        set -e
        
        echo "ğŸš€ Starting build process..."
        
        # FRONTEND BUILD
        echo "ğŸ“¦ Building frontend..."
        cd frontend
        
        # KLJUÄŒNO: Postavi NODE_ENV na development za install
        export NODE_ENV=development
        
        echo "ğŸ“¥ Installing ALL dependencies (dev + production)..."
        npm install
        
        # Verifikacija instalacije
        echo "ğŸ” Verifying installations..."
        echo "Installed packages:"
        npm list --depth=0
        
        echo ""
        echo "Checking Vite specifically:"
        npm list vite || echo "WARNING: Vite not in npm list"
        
        echo ""
        echo "Checking .bin folder:"
        ls -la node_modules/.bin/ | grep vite || echo "WARNING: No vite in .bin"
        
        # Ako Vite nije u .bin, pokuÅ¡aj direktni path
        if [ ! -f "node_modules/.bin/vite" ]; then
          echo "âš ï¸  Vite binary not found, trying direct node_modules path..."
          if [ -f "node_modules/vite/bin/vite.js" ]; then
            echo "âœ… Found vite.js, creating symlink..."
            ln -sf "$(pwd)/node_modules/vite/bin/vite.js" node_modules/.bin/vite
            chmod +x node_modules/.bin/vite
          fi
        fi
        
        # Build sa production env
        export NODE_ENV=production
        echo "ğŸ—ï¸ Running Vite build..."
        npm run build
        
        # Provjera
        if [ ! -f "dist/index.html" ]; then
          echo "âŒ Build failed - dist/index.html not found"
          echo "Directory contents:"
          ls -la
          exit 1
        fi
        
        echo "âœ… Frontend build successful!"
        echo "Built files:"
        ls -la dist/
        
        # BACKEND
        echo ""
        echo "ğŸ“¦ Installing backend dependencies..."
        cd ../backend
        export NODE_ENV=production
        npm install --omit=dev
        
        echo "ğŸ‰ Build completed successfully!"
      
      deploy: |
        echo "ğŸš€ Application deployed successfully"
        echo "ğŸ“Š Frontend served from: frontend/dist"
        echo "ğŸ”§ Backend running on port: ${PORT}"
        echo "ğŸ—„ï¸ Database: PostgreSQL"

    mounts:
      "/backend/uploads":
        source: local
        source_path: uploads

    variables:
      env:
        NODE_ENV: "production"
        PORT: 8888
        JWT_SECRET: "your-very-secure-jwt-secret-key-change-this-in-production"

services:
  postgresql:
    type: postgresql:15

routes:
  "https://{default}/":
    type: upstream
    upstream: "app:http"
  "https://www.{default}/":
    type: redirect
    to: "https://{default}/"