# .upsun.yaml - SINGLE APP
applications:
  app:
    type: "nodejs:20"
    relationships:
      database:
        service: postgresql
        endpoint: postgresql

    web:
      commands:
        start: "node backend/server.js"
      locations:
        "/":
          root: "frontend/dist"
          index: ["index.html"]
          passthru: true
          expires: -1
          allow: true
          scripts: true
        "/assets":
          root: "frontend/dist/assets"
          expires: 1y
          allow: true
        "/api":
          passthru: true

hooks:
  build: |
    set -e
        
    echo "ğŸš€ Starting alternative build process..."

    # Prvo backend da ne blokiramo
    echo "ğŸ“¦ Backend setup..."
    cd backend
    npm install
    cd ..

    # Frontend sa eksplicitnim pokretanjem
    echo "ğŸ“¦ Frontend setup..."
    cd frontend

    # Clean install
    rm -rf node_modules
    npm install

    # Probaj razliÄite naÄine buildanja
    echo "ğŸ”„ Trying different build methods..."

    # Metoda 1: npx (najbolja)
    npx vite build || {
      echo "âŒ npx vite build failed, trying alternative..."
      
      # Metoda 2: direktno s node
      node node_modules/vite/bin/vite.js build || {
        echo "âŒ node vite build failed, trying global install..."
        
        # Metoda 3: globalni Vite
        npm install -g vite
        vite build
      }
    }

    # KonaÄna provjera
    if [ ! -f "dist/index.html" ]; then
      echo "âŒ All build methods failed"
      exit 1
    fi

    echo "âœ… Frontend build successful"

    # ZavrÅ¡i s bazom
    cd ../backend
    npm run init-db

    echo "ğŸ‰ Build completed!"

variables:
  env:
    NODE_ENV: "production"
    PORT: 8888

services:
  postgresql:
    type: postgresql:15
