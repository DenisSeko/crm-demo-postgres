applications:
  app:
    type: 'nodejs:20'
    relationships:
      database:
        service: postgresql
        endpoint: postgresql
    
    web:
      commands:
        start: "node backend/server.js"
      locations:
        '/':
          root: 'frontend/dist'
          index: ['index.html']
          passthru: true
          expires: -1
          allow: true
          scripts: true
        '/assets':
          root: 'frontend/dist/assets'
          expires: 1y
          allow: true
        '/api':
          passthru: true
    
    hooks:
      build: |
        set -e
        
        echo "ğŸ“¦ Installing frontend dependencies..."
        cd frontend
        npm ci
        
        echo "ğŸ—ï¸ Building frontend..."
        npm run build
        
        if [ ! -d "dist" ]; then
          echo "âŒ Frontend build failed - no dist directory"
          exit 1
        fi
        echo "âœ… Frontend build successful"
        
        echo "ğŸ“¦ Installing backend dependencies..."
        cd ../backend
        npm ci
        
        echo "ğŸ—„ï¸ Initializing database with demo data..."
        npm run init-db
        
        echo "âœ… Build completed successfully!"
    
    mounts:
      'backend/node_modules':
        source: local
        source_path: 'backend/node_modules'
      'frontend/node_modules':
        source: local
        source_path: 'frontend/node_modules'
    
    variables:
      env:
        NODE_ENV: 'production'
        PORT: 8888
        JWT_SECRET: 'your-very-secure-jwt-secret-key-change-this-in-production'

services:
  postgresql:
    type: postgresql:15